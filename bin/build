#!/usr/bin/env bash

set -e

export DOCKER_BUILDKIT=1
DEBUG=false

if [ "$1" == "--debug" ]; then
    DEBUG=true
fi

cd $(dirname $0)/..

. bin/build_utils

FULL_VERSION_TAG="$(full_version_tag)"

echo "---"

if [ $DEBUG = true ]; then
  echo "Building secrets-provider-debug Docker image"

  docker build \
    --tag "secrets-provider-for-k8s-debug:latest" \
    --target "secrets-provider-debug" \
    .
else
  echo "Building secrets-provider-for-k8s Docker image"

  docker build \
    --tag "secrets-provider-for-k8s:dev" \
    --tag "secrets-provider-for-k8s:${FULL_VERSION_TAG}" \
    --tag "secrets-provider-for-k8s:latest" \
    --target "secrets-provider" \
    .

  echo "Building secrets-provider-for-k8s-redhat:$FULL_VERSION_TAG Docker image"

  docker build --tag "secrets-provider-for-k8s-redhat:${FULL_VERSION_TAG}" \
     --build-arg VERSION="$FULL_VERSION_TAG" \
     --target "secrets-provider-redhat" \
     .
fi

echo "---"
