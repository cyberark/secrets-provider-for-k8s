#!/usr/bin/env bash

set -e

. bin/build_utils

FULL_VERSION_TAG="$(full_version_tag)"

function finish {
    rm -f secrets-provider
}
trap finish EXIT

docker build --tag secrets-provider-for-k8s-go:builder .

docker run --rm \
           -v $PWD:/opt/secrets-provider-for-k8s \
           secrets-provider-for-k8s-go:builder env CGO_ENABLED=1 GOOS=linux \
                                              /bin/bash -c "go build -a -installsuffix cgo -o secrets-provider ./cmd/secrets-provider && go tool nm secrets-provider"

echo "Building secrets-provider-for-k8s:$FULL_VERSION_TAG Docker image"
docker build -f Dockerfile.scratch \
             --tag "secrets-provider-for-k8s:dev" \
             --tag "secrets-provider-for-k8s:${FULL_VERSION_TAG}" \
             --tag "secrets-provider-for-k8s:latest" \
             .

echo "---"
